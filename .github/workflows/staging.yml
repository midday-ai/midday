name: Staging

permissions:
  contents: read

on:
  push:
    branches-ignore:
      - main

concurrency:
  group: staging-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  # ---------------------------------------------------------------------------
  # Detect which services/packages changed (for deploy gating)
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect changes
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 5
    outputs:
      api: ${{ steps.filter.outputs.api }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      worker: ${{ steps.filter.outputs.worker }}
      engine: ${{ steps.filter.outputs.engine }}
      website: ${{ steps.filter.outputs.website }}
      jobs: ${{ steps.filter.outputs.jobs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
              - '!packages/email/**'
              - '!packages/ui/**'
            dashboard:
              - 'apps/dashboard/**'
              - 'packages/**'
            worker:
              - 'apps/worker/**'
              - 'packages/**'
              - '!packages/email/**'
              - '!packages/ui/**'
            engine:
              - 'apps/engine/**'
            website:
              - 'apps/website/**'
              - 'packages/ui/**'
              - 'packages/app-store/**'
            jobs:
              - 'packages/jobs/**'

  # ---------------------------------------------------------------------------
  # Validate â€” runs in parallel with detect-changes (turbo handles scoping)
  # ---------------------------------------------------------------------------
  validate:
    name: Validate
    runs-on: blacksmith-16vcpu-ubuntu-2404
    timeout-minutes: 20
    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - name: Validate affected packages
        run: |
          bunx turbo test lint typecheck --filter="...[HEAD~1]"

  # ---------------------------------------------------------------------------
  # Deploy API to Railway staging
  # ---------------------------------------------------------------------------
  deploy-api-staging:
    name: Deploy API (staging)
    needs: [detect-changes, validate]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.api == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 20
    concurrency: railway-api-staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Railway
        run: npx @railway/cli up --service ${{ secrets.RAILWAY_API_STAGING_SERVICE_ID }} --environment production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ---------------------------------------------------------------------------
  # Deploy Dashboard to Railway staging (waits for API when both change)
  # ---------------------------------------------------------------------------
  deploy-dashboard-staging:
    name: Deploy Dashboard (staging)
    needs: [detect-changes, validate, deploy-api-staging]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.dashboard == 'true' &&
      (needs.deploy-api-staging.result == 'success' || needs.deploy-api-staging.result == 'skipped')
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 20
    concurrency: railway-dashboard-staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Railway
        run: npx @railway/cli up --service ${{ secrets.RAILWAY_DASHBOARD_SERVICE_ID }} --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ---------------------------------------------------------------------------
  # Deploy Worker to Railway staging (waits for API when both change)
  # ---------------------------------------------------------------------------
  deploy-worker-staging:
    name: Deploy Worker (staging)
    needs: [detect-changes, validate, deploy-api-staging]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.worker == 'true' &&
      (needs.deploy-api-staging.result == 'success' || needs.deploy-api-staging.result == 'skipped')
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 20
    concurrency: railway-worker-staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Railway
        run: npx @railway/cli up --service ${{ secrets.RAILWAY_WORKER_STAGING_SERVICE_ID }} --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ---------------------------------------------------------------------------
  # Deploy Engine to Cloudflare staging
  # ---------------------------------------------------------------------------
  deploy-engine-staging:
    name: Deploy Engine (staging)
    needs: [detect-changes, validate]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.engine == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          packageManager: bun
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: "apps/engine"
          wranglerVersion: "4.33.2"
          command: deploy --minify src/index.ts --env staging

  # ---------------------------------------------------------------------------
  # Deploy Jobs to Trigger.dev staging
  # ---------------------------------------------------------------------------
  deploy-jobs-staging:
    name: Deploy Jobs (staging)
    needs: [detect-changes, validate]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.jobs == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Deploy to Trigger.dev
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
        run: |
          TRIGGER_PROJECT_ID=${{ secrets.TRIGGER_PROJECT_ID }} bunx trigger.dev@4.1.2 deploy --env staging
        working-directory: packages/jobs

  # ---------------------------------------------------------------------------
  # Deploy Website preview to Vercel
  # ---------------------------------------------------------------------------
  deploy-website-preview:
    name: Deploy Website (preview)
    needs: [detect-changes, validate]
    if: >-
      always() &&
      needs.validate.result == 'success' &&
      needs.detect-changes.outputs.website == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 20
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEBSITE }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Pull Vercel environment
        run: bunx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: bunx vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy
        run: bunx vercel deploy --prebuilt --archive=tgz --token=${{ secrets.VERCEL_TOKEN }}
