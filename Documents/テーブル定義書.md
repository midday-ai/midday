# Midday データベース テーブル定義書

## 概要

このドキュメントは、Middayアプリケーションのデータベーススキーマ定義を説明します。PostgreSQLデータベースを使用し、Drizzle ORMでスキーマ管理を行っています。

## データベース管理ツール

- **ORM**: Drizzle ORM
- **マイグレーション管理**: Drizzle Kit
- **データベース**: PostgreSQL
- **スキーマ定義ファイル**: `packages/db/src/schema.ts`

## テーブル一覧

### 1. ユーザー・チーム関連

#### users (ユーザー)
| カラム名               | データ型      | 制約            | 説明         |
| ------------------ | --------- | ------------- | ---------- |
| id                 | uuid      | PRIMARY KEY   | ユーザーID     |
| fullName           | text      | -             | フルネーム      |
| avatarUrl          | text      | -             | アバター画像URL  |
| email              | text      | -             | メールアドレス    |
| teamId             | uuid      | FOREIGN KEY   | 所属チームID    |
| createdAt          | timestamp | DEFAULT now() | 作成日時       |
| locale             | text      | DEFAULT 'en'  | ロケール設定     |
| weekStartsOnMonday | boolean   | DEFAULT false | 週の開始日設定    |
| timezone           | text      | -             | タイムゾーン     |
| timezoneAutoSync   | boolean   | DEFAULT true  | タイムゾーン自動同期 |
| timeFormat         | numeric   | DEFAULT 24    | 時刻フォーマット   |
| dateFormat         | text      | -             | 日付フォーマット   |

#### teams (チーム)
| カラム名                   | データ型      | 制約                         | 説明         |
| ---------------------- | --------- | -------------------------- | ---------- |
| id                     | uuid      | PRIMARY KEY                | チームID      |
| createdAt              | timestamp | DEFAULT now()              | 作成日時       |
| name                   | text      | -                          | チーム名       |
| logoUrl                | text      | -                          | ロゴURL      |
| inboxId                | text      | DEFAULT generate_inbox(10) | インボックスID   |
| email                  | text      | -                          | メールアドレス    |
| inboxEmail             | text      | -                          | インボックスメール  |
| inboxForwarding        | boolean   | DEFAULT true               | インボックス転送設定 |
| baseCurrency           | text      | -                          | 基本通貨       |
| countryCode            | text      | -                          | 国コード       |
| documentClassification | boolean   | DEFAULT false              | 文書分類設定     |
| flags                  | text[]    | -                          | フラグ配列      |
| canceledAt             | timestamp | -                          | キャンセル日時    |
| plan                   | plans     | DEFAULT 'trial'            | プラン        |

#### users_on_team (チームメンバー)
| カラム名      | データ型      | 制約            | 説明     |
| --------- | --------- | ------------- | ------ |
| userId    | uuid      | PRIMARY KEY   | ユーザーID |
| teamId    | uuid      | PRIMARY KEY   | チームID  |
| id        | uuid      | NOT NULL      | レコードID |
| role      | teamRoles | -             | ロール    |
| createdAt | timestamp | DEFAULT now() | 作成日時   |

### 2. 取引・財務関連

#### transactions (取引)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 取引ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| date | date | NOT NULL | 取引日 |
| name | text | NOT NULL | 取引名 |
| method | transactionMethods | NOT NULL | 取引方法 |
| amount | numeric(10,2) | NOT NULL | 金額 |
| currency | text | NOT NULL | 通貨 |
| teamId | uuid | NOT NULL | チームID |
| assignedId | uuid | - | 担当者ID |
| note | varchar | - | メモ |
| bankAccountId | uuid | - | 銀行口座ID |
| internalId | text | NOT NULL | 内部ID |
| status | transactionStatus | DEFAULT 'posted' | ステータス |
| category | transactionCategories | - | カテゴリ |
| balance | numeric(10,2) | - | 残高 |
| manual | boolean | DEFAULT false | 手動入力フラグ |
| notified | boolean | DEFAULT false | 通知済みフラグ |
| internal | boolean | DEFAULT false | 内部取引フラグ |
| description | text | - | 説明 |
| categorySlug | text | - | カテゴリスラッグ |
| baseAmount | numeric(10,2) | - | 基本金額 |
| counterpartyName | text | - | 取引先名 |
| baseCurrency | text | - | 基本通貨 |
| taxRate | numeric(10,2) | - | 税率 |
| taxType | text | - | 税種別 |
| recurring | boolean | - | 定期取引フラグ |
| frequency | transaction_frequency | - | 頻度 |
| merchantName | text | - | 加盟店名 |
| enrichmentCompleted | boolean | DEFAULT false | エンリッチメント完了フラグ |
| ftsVector | tsvector | GENERATED | 全文検索ベクトル |

#### transaction_categories (取引カテゴリ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | NOT NULL | カテゴリID |
| name | text | NOT NULL | カテゴリ名 |
| teamId | uuid | NOT NULL | チームID |
| color | text | - | 色 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| system | boolean | DEFAULT false | システムカテゴリフラグ |
| slug | text | - | スラッグ |
| taxRate | numeric(10,2) | - | 税率 |
| taxType | text | - | 税種別 |
| description | text | - | 説明 |
| embedding | vector(384) | - | 埋め込みベクトル |
| parentId | uuid | - | 親カテゴリID |

#### bank_accounts (銀行口座)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 口座ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| createdBy | uuid | NOT NULL | 作成者ID |
| teamId | uuid | NOT NULL | チームID |
| name | text | - | 口座名 |
| currency | text | - | 通貨 |
| bankConnectionId | uuid | - | 銀行接続ID |
| enabled | boolean | DEFAULT true | 有効フラグ |
| accountId | text | NOT NULL | アカウントID |
| balance | numeric(10,2) | DEFAULT 0 | 残高 |
| manual | boolean | DEFAULT false | 手動入力フラグ |
| type | account_type | - | 口座タイプ |
| baseCurrency | text | - | 基本通貨 |
| baseBalance | numeric(10,2) | - | 基本残高 |
| errorDetails | text | - | エラー詳細 |
| errorRetries | smallint | - | エラーリトライ回数 |
| accountReference | text | - | アカウント参照 |

#### bank_connections (銀行接続)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 接続ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| institutionId | text | NOT NULL | 金融機関ID |
| expiresAt | timestamp | - | 有効期限 |
| teamId | uuid | NOT NULL | チームID |
| name | text | NOT NULL | 接続名 |
| logoUrl | text | - | ロゴURL |
| accessToken | text | - | アクセストークン |
| enrollmentId | text | - | 登録ID |
| provider | bank_providers | NOT NULL | プロバイダー |
| lastAccessed | timestamp | - | 最終アクセス日時 |
| referenceId | text | - | 参照ID |
| status | connection_status | DEFAULT 'connected' | ステータス |
| errorDetails | text | - | エラー詳細 |
| errorRetries | smallint | DEFAULT 0 | エラーリトライ回数 |

### 3. 請求書関連

#### invoices (請求書)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 請求書ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| updatedAt | timestamp | DEFAULT now() | 更新日時 |
| dueDate | timestamp | - | 支払期限 |
| invoiceNumber | text | - | 請求書番号 |
| customerId | uuid | - | 顧客ID |
| amount | numeric(10,2) | - | 金額 |
| currency | text | - | 通貨 |
| lineItems | jsonb | - | 明細項目 |
| paymentDetails | jsonb | - | 支払い詳細 |
| customerDetails | jsonb | - | 顧客詳細 |
| companyDatails | jsonb | - | 会社詳細 |
| note | text | - | メモ |
| internalNote | text | - | 内部メモ |
| teamId | uuid | NOT NULL | チームID |
| paidAt | timestamp | - | 支払日時 |
| fts | tsvector | GENERATED | 全文検索ベクトル |
| vat | numeric(10,2) | - | VAT |
| tax | numeric(10,2) | - | 税額 |
| url | text | - | URL |
| filePath | text[] | - | ファイルパス配列 |
| status | invoice_status | DEFAULT 'draft' | ステータス |
| viewedAt | timestamp | - | 閲覧日時 |
| fromDetails | jsonb | - | 差出人詳細 |
| issueDate | timestamp | - | 発行日 |
| template | jsonb | - | テンプレート |
| noteDetails | jsonb | - | メモ詳細 |
| customerName | text | - | 顧客名 |
| token | text | DEFAULT '' | トークン |
| sentTo | text | - | 送信先 |
| reminderSentAt | timestamp | - | リマインダー送信日時 |
| discount | numeric(10,2) | - | 割引額 |
| fileSize | bigint | - | ファイルサイズ |
| userId | uuid | - | ユーザーID |
| subtotal | numeric(10,2) | - | 小計 |
| topBlock | jsonb | - | 上部ブロック |
| bottomBlock | jsonb | - | 下部ブロック |
| sentAt | timestamp | - | 送信日時 |
| scheduledAt | timestamp | - | スケジュール日時 |
| scheduledJobId | text | - | スケジュールジョブID |

#### customers (顧客)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 顧客ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| name | text | NOT NULL | 顧客名 |
| email | text | NOT NULL | メールアドレス |
| billingEmail | text | - | 請求メール |
| country | text | - | 国 |
| addressLine1 | text | - | 住所1 |
| addressLine2 | text | - | 住所2 |
| city | text | - | 市区町村 |
| state | text | - | 都道府県 |
| zip | text | - | 郵便番号 |
| note | text | - | メモ |
| teamId | uuid | DEFAULT gen_random_uuid() | チームID |
| website | text | - | ウェブサイト |
| phone | text | - | 電話番号 |
| vatNumber | text | - | VAT番号 |
| countryCode | text | - | 国コード |
| token | text | DEFAULT '' | トークン |
| contact | text | - | 連絡先 |
| fts | tsvector | GENERATED | 全文検索ベクトル |

#### invoice_templates (請求書テンプレート)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | テンプレートID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | NOT NULL | チームID |
| customerLabel | text | - | 顧客ラベル |
| fromLabel | text | - | 差出人ラベル |
| invoiceNoLabel | text | - | 請求書番号ラベル |
| issueDateLabel | text | - | 発行日ラベル |
| dueDateLabel | text | - | 支払期限ラベル |
| descriptionLabel | text | - | 説明ラベル |
| priceLabel | text | - | 価格ラベル |
| quantityLabel | text | - | 数量ラベル |
| totalLabel | text | - | 合計ラベル |
| vatLabel | text | - | VATラベル |
| taxLabel | text | - | 税ラベル |
| paymentLabel | text | - | 支払いラベル |
| noteLabel | text | - | メモラベル |
| logoUrl | text | - | ロゴURL |
| currency | text | - | 通貨 |
| paymentDetails | jsonb | - | 支払い詳細 |
| fromDetails | jsonb | - | 差出人詳細 |
| size | invoice_size | DEFAULT 'a4' | サイズ |
| dateFormat | text | - | 日付フォーマット |
| includeVat | boolean | - | VAT含むフラグ |
| includeTax | boolean | - | 税含むフラグ |
| taxRate | numeric(10,2) | - | 税率 |
| deliveryType | invoice_delivery_type | DEFAULT 'create' | 配信タイプ |
| discountLabel | text | - | 割引ラベル |
| includeDiscount | boolean | - | 割引含むフラグ |
| includeDecimals | boolean | - | 小数点含むフラグ |
| includeQr | boolean | - | QRコード含むフラグ |
| totalSummaryLabel | text | - | 合計サマリーラベル |
| title | text | - | タイトル |
| vatRate | numeric(10,2) | - | VAT率 |
| includeUnits | boolean | - | 単位含むフラグ |
| subtotalLabel | text | - | 小計ラベル |
| includePdf | boolean | - | PDF含むフラグ |
| sendCopy | boolean | - | コピー送信フラグ |

### 4. ドキュメント・ファイル関連

#### documents (ドキュメント)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | ドキュメントID |
| name | text | - | ドキュメント名 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| metadata | jsonb | - | メタデータ |
| pathTokens | text[] | - | パストークン配列 |
| teamId | uuid | - | チームID |
| parentId | text | - | 親ID |
| objectId | uuid | - | オブジェクトID |
| ownerId | uuid | - | 所有者ID |
| tag | text | - | タグ |
| title | text | - | タイトル |
| body | text | - | 本文 |
| fts | tsvector | GENERATED | 全文検索ベクトル |
| summary | text | - | サマリー |
| content | text | - | コンテンツ |
| date | date | - | 日付 |
| language | text | - | 言語 |
| processingStatus | document_processing_status | DEFAULT 'pending' | 処理ステータス |
| ftsSimple | tsvector | - | 簡易全文検索ベクトル |
| ftsEnglish | tsvector | - | 英語全文検索ベクトル |
| ftsLanguage | tsvector | - | 言語別全文検索ベクトル |

#### document_tags (ドキュメントタグ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | タグID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| name | text | NOT NULL | タグ名 |
| slug | text | NOT NULL | スラッグ |
| teamId | uuid | NOT NULL | チームID |

#### document_tag_assignments (ドキュメントタグ割り当て)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| documentId | uuid | PRIMARY KEY | ドキュメントID |
| tagId | uuid | PRIMARY KEY | タグID |
| teamId | uuid | NOT NULL | チームID |

### 5. トラッカー・プロジェクト関連

#### tracker_projects (トラッカープロジェクト)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | プロジェクトID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | - | チームID |
| rate | numeric(10,2) | - | レート |
| currency | text | - | 通貨 |
| status | trackerStatus | DEFAULT 'in_progress' | ステータス |
| description | text | - | 説明 |
| name | text | NOT NULL | プロジェクト名 |
| billable | boolean | DEFAULT false | 請求可能フラグ |
| estimate | bigint | - | 見積もり |
| customerId | uuid | - | 顧客ID |
| fts | tsvector | GENERATED | 全文検索ベクトル |

#### tracker_entries (トラッカーエントリ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | エントリID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| duration | bigint | - | 時間 |
| projectId | uuid | - | プロジェクトID |
| start | timestamp | - | 開始時刻 |
| stop | timestamp | - | 終了時刻 |
| assignedId | uuid | - | 担当者ID |
| teamId | uuid | - | チームID |
| description | text | - | 説明 |
| rate | numeric(10,2) | - | レート |
| currency | text | - | 通貨 |
| billed | boolean | DEFAULT false | 請求済みフラグ |
| date | date | DEFAULT now() | 日付 |

### 6. インボックス・メール関連

#### inbox (インボックス)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | インボックスID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | - | チームID |
| filePath | text[] | - | ファイルパス配列 |
| fileName | text | - | ファイル名 |
| transactionId | uuid | - | 取引ID |
| amount | numeric(10,2) | - | 金額 |
| currency | text | - | 通貨 |
| contentType | text | - | コンテンツタイプ |
| size | bigint | - | サイズ |
| attachmentId | uuid | - | 添付ファイルID |
| date | date | - | 日付 |
| forwardedTo | text | - | 転送先 |
| referenceId | text | - | 参照ID |
| meta | json | - | メタデータ |
| status | inbox_status | DEFAULT 'new' | ステータス |
| website | text | - | ウェブサイト |
| displayName | text | - | 表示名 |
| fts | tsvector | GENERATED | 全文検索ベクトル |
| type | inbox_type | - | タイプ |
| description | text | - | 説明 |
| baseAmount | numeric(10,2) | - | 基本金額 |
| baseCurrency | text | - | 基本通貨 |
| taxAmount | numeric(10,2) | - | 税額 |
| taxRate | numeric(10,2) | - | 税率 |
| taxType | text | - | 税種別 |
| inboxAccountId | uuid | - | インボックスアカウントID |

#### inbox_accounts (インボックスアカウント)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | アカウントID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| email | text | NOT NULL | メールアドレス |
| accessToken | text | NOT NULL | アクセストークン |
| refreshToken | text | NOT NULL | リフレッシュトークン |
| teamId | uuid | NOT NULL | チームID |
| lastAccessed | timestamp | NOT NULL | 最終アクセス日時 |
| provider | inbox_account_providers | NOT NULL | プロバイダー |
| externalId | text | NOT NULL | 外部ID |
| expiryDate | timestamp | NOT NULL | 有効期限 |
| scheduleId | text | - | スケジュールID |
| status | inbox_account_status | DEFAULT 'connected' | ステータス |
| errorMessage | text | - | エラーメッセージ |

### 7. タグ・分類関連

#### tags (タグ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | タグID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | NOT NULL | チームID |
| name | text | NOT NULL | タグ名 |

#### transaction_tags (取引タグ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | タグID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | NOT NULL | チームID |
| tagId | uuid | NOT NULL | タグID |
| transactionId | uuid | NOT NULL | 取引ID |

#### customer_tags (顧客タグ)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | タグID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| customerId | uuid | NOT NULL | 顧客ID |
| teamId | uuid | NOT NULL | チームID |
| tagId | uuid | NOT NULL | タグID |

### 8. レポート・分析関連

#### reports (レポート)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | レポートID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| linkId | text | - | リンクID |
| teamId | uuid | - | チームID |
| shortLink | text | - | 短縮リンク |
| from | timestamp | - | 開始日時 |
| to | timestamp | - | 終了日時 |
| type | reportTypes | - | レポートタイプ |
| expireAt | timestamp | - | 有効期限 |
| currency | text | - | 通貨 |
| createdBy | uuid | - | 作成者ID |

#### tracker_reports (トラッカーレポート)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | レポートID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| linkId | text | - | リンクID |
| shortLink | text | - | 短縮リンク |
| teamId | uuid | DEFAULT gen_random_uuid() | チームID |
| projectId | uuid | DEFAULT gen_random_uuid() | プロジェクトID |
| createdBy | uuid | - | 作成者ID |

### 9. 認証・セキュリティ関連

#### api_keys (APIキー)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | APIキーID |
| keyEncrypted | text | NOT NULL | 暗号化されたキー |
| name | text | NOT NULL | キー名 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| userId | uuid | NOT NULL | ユーザーID |
| teamId | uuid | NOT NULL | チームID |
| keyHash | text | - | キーハッシュ |
| scopes | text[] | DEFAULT '{}' | スコープ配列 |
| lastUsedAt | timestamp | - | 最終使用日時 |

#### user_invites (ユーザー招待)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 招待ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| teamId | uuid | - | チームID |
| email | text | - | メールアドレス |
| role | teamRoles | - | ロール |
| code | text | DEFAULT 'nanoid(24)' | 招待コード |
| invitedBy | uuid | - | 招待者ID |

### 10. OAuth関連

#### oauth_applications (OAuthアプリケーション)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | アプリケーションID |
| name | text | NOT NULL | アプリケーション名 |
| slug | text | NOT NULL UNIQUE | スラッグ |
| description | text | - | 説明 |
| overview | text | - | 概要 |
| developerName | text | - | 開発者名 |
| logoUrl | text | - | ロゴURL |
| website | text | - | ウェブサイト |
| installUrl | text | - | インストールURL |
| screenshots | text[] | DEFAULT '{}' | スクリーンショット配列 |
| redirectUris | text[] | NOT NULL | リダイレクトURI配列 |
| clientId | text | NOT NULL UNIQUE | クライアントID |
| clientSecret | text | NOT NULL | クライアントシークレット |
| scopes | text[] | DEFAULT '{}' | スコープ配列 |
| teamId | uuid | NOT NULL | チームID |
| createdBy | uuid | NOT NULL | 作成者ID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| updatedAt | timestamp | DEFAULT now() | 更新日時 |
| isPublic | boolean | DEFAULT false | 公開フラグ |
| active | boolean | DEFAULT true | アクティブフラグ |
| status | text | DEFAULT 'draft' | ステータス |

#### oauth_authorization_codes (OAuth認可コード)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 認可コードID |
| code | text | NOT NULL UNIQUE | 認可コード |
| applicationId | uuid | NOT NULL | アプリケーションID |
| userId | uuid | NOT NULL | ユーザーID |
| teamId | uuid | NOT NULL | チームID |
| scopes | text[] | NOT NULL | スコープ配列 |
| redirectUri | text | NOT NULL | リダイレクトURI |
| expiresAt | timestamp | NOT NULL | 有効期限 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| used | boolean | DEFAULT false | 使用済みフラグ |
| codeChallenge | text | - | コードチャレンジ |
| codeChallengeMethod | text | - | コードチャレンジメソッド |

#### oauth_access_tokens (OAuthアクセストークン)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | トークンID |
| token | text | NOT NULL UNIQUE | アクセストークン |
| refreshToken | text | UNIQUE | リフレッシュトークン |
| applicationId | uuid | NOT NULL | アプリケーションID |
| userId | uuid | NOT NULL | ユーザーID |
| teamId | uuid | NOT NULL | チームID |
| scopes | text[] | NOT NULL | スコープ配列 |
| expiresAt | timestamp | NOT NULL | 有効期限 |
| refreshTokenExpiresAt | timestamp | - | リフレッシュトークン有効期限 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| lastUsedAt | timestamp | - | 最終使用日時 |
| revoked | boolean | DEFAULT false | 無効化フラグ |
| revokedAt | timestamp | - | 無効化日時 |

### 11. その他

#### exchange_rates (為替レート)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | レートID |
| base | text | - | 基本通貨 |
| rate | numeric(10,2) | - | レート |
| target | text | - | 対象通貨 |
| updatedAt | timestamp | - | 更新日時 |

#### short_links (短縮リンク)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | リンクID |
| shortId | text | NOT NULL | 短縮ID |
| url | text | NOT NULL | URL |
| type | text | - | タイプ |
| size | numeric(10,2) | - | サイズ |
| mimeType | text | - | MIMEタイプ |
| fileName | text | - | ファイル名 |
| teamId | uuid | NOT NULL | チームID |
| userId | uuid | NOT NULL | ユーザーID |
| expiresAt | timestamp | - | 有効期限 |
| createdAt | timestamp | DEFAULT now() | 作成日時 |

#### transaction_enrichments (取引エンリッチメント)
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | エンリッチメントID |
| createdAt | timestamp | DEFAULT now() | 作成日時 |
| name | text | - | 名前 |
| teamId | uuid | - | チームID |
| categorySlug | text | - | カテゴリスラッグ |
| system | boolean | DEFAULT false | システムフラグ |

## 列挙型 (Enums)

### account_type
- depository (預金)
- credit (クレジット)
- other_asset (その他資産)
- loan (ローン)
- other_liability (その他負債)

### bank_providers
- gocardless
- plaid
- teller
- enablebanking

### connection_status
- disconnected (切断)
- connected (接続)
- unknown (不明)

### document_processing_status
- pending (保留)
- processing (処理中)
- completed (完了)
- failed (失敗)

### inbox_account_providers
- gmail
- outlook

### inbox_account_status
- connected (接続)
- disconnected (切断)

### inbox_status
- processing (処理中)
- pending (保留)
- archived (アーカイブ)
- new (新規)
- deleted (削除)
- done (完了)

### inbox_type
- invoice (請求書)
- expense (経費)

### invoice_delivery_type
- create (作成)
- create_and_send (作成・送信)
- scheduled (スケジュール)

### invoice_size
- a4
- letter

### invoice_status
- draft (下書き)
- overdue (期限超過)
- paid (支払済み)
- unpaid (未払い)
- canceled (キャンセル)
- scheduled (スケジュール)

### plans
- trial (トライアル)
- starter (スターター)
- pro (プロ)

### reportTypes
- profit (利益)
- revenue (収益)
- burn_rate (バーンレート)
- expense (経費)

### teamRoles
- owner (所有者)
- member (メンバー)

### trackerStatus
- in_progress (進行中)
- completed (完了)

### transactionCategories
- travel (旅行)
- office-supplies (事務用品)
- meals (食事)
- software (ソフトウェア)
- rent (家賃)
- income (収入)
- equipment (設備)
- transfer (振替)
- internet-and-telephone (インターネット・電話)
- facilities-expenses (施設費)
- activity (活動)
- uncategorized (未分類)
- taxes (税金)
- other (その他)
- salary (給与)
- fees (手数料)

### transactionMethods
- payment (支払い)
- card_purchase (カード購入)
- card_atm (カードATM)
- transfer (振替)
- other (その他)
- unknown (不明)
- ach (ACH)
- interest (利息)
- deposit (預金)
- wire (送金)
- fee (手数料)

### transactionStatus
- posted (記帳済み)
- pending (保留)
- excluded (除外)
- completed (完了)
- archived (アーカイブ)

### transaction_frequency
- weekly (週次)
- biweekly (隔週)
- monthly (月次)
- semi_monthly (半月)
- annually (年次)
- irregular (不定期)
- unknown (不明)

## インデックス

各テーブルには以下のようなインデックスが設定されています：

- **主キーインデックス**: 各テーブルの主キー
- **外部キーインデックス**: 外部キー参照のためのインデックス
- **全文検索インデックス**: tsvector型のカラムに対するGINインデックス
- **複合インデックス**: 複数のカラムに対する複合インデックス
- **ベクトルインデックス**: 埋め込みベクトルに対するHNSWインデックス

## ポリシー (Row Level Security)

各テーブルにはRow Level Security (RLS) ポリシーが設定されており、以下のような制御が行われています：

- **チームベースのアクセス制御**: ユーザーは自分のチームのデータのみアクセス可能
- **認証ユーザーのみ**: 認証されたユーザーのみがデータにアクセス可能
- **CRUD操作の制御**: 作成、読み取り、更新、削除の各操作に対する制御

## 生成列 (Generated Columns)

以下のテーブルには生成列が設定されています：

- **ftsVector**: 全文検索用のtsvector型の生成列
- **fts**: 同様に全文検索用のtsvector型の生成列

これらの列は、指定されたテキストカラムの内容から自動的に生成され、全文検索のパフォーマンスを向上させます。

## 注意事項

1. **UUIDの使用**: ほとんどのテーブルでUUIDが主キーとして使用されています
2. **タイムスタンプ**: 作成日時は自動的に設定されます
3. **外部キー制約**: 適切な外部キー制約が設定されています
4. **カスケード削除**: 一部の関連テーブルではカスケード削除が設定されています
5. **デフォルト値**: 多くのカラムに適切なデフォルト値が設定されています

---

*このドキュメントは `packages/db/src/schema.ts` から自動生成されました。*
*最終更新: 2024年*
