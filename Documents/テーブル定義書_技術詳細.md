# Midday データベース テーブル定義書 - 技術詳細

## インデックス

### transactions テーブルのインデックス
- `idx_transactions_date` - 日付のB-treeインデックス
- `idx_transactions_fts` - 全文検索のGINインデックス
- `idx_transactions_fts_vector` - 全文検索ベクトルのGINインデックス
- `idx_transactions_id` - IDのB-treeインデックス
- `idx_transactions_name` - 名前のB-treeインデックス
- `idx_transactions_name_trigram` - 名前のtrigram GINインデックス
- `idx_transactions_team_id_date_name` - チームID、日付、名前の複合B-treeインデックス
- `idx_transactions_team_id_name` - チームID、名前の複合B-treeインデックス
- `idx_trgm_name` - 名前のtrigram GISTインデックス
- `transactions_assigned_id_idx` - 担当者IDのB-treeインデックス
- `transactions_bank_account_id_idx` - 銀行口座IDのB-treeインデックス
- `transactions_category_slug_idx` - カテゴリスラッグのB-treeインデックス
- `transactions_team_id_date_currency_bank_account_id_category_idx` - 複合B-treeインデックス
- `transactions_team_id_idx` - チームIDのB-treeインデックス

### documents テーブルのインデックス
- `documents_name_idx` - 名前のB-treeインデックス
- `documents_team_id_idx` - チームIDのB-treeインデックス
- `documents_team_id_parent_id_idx` - チームID、親IDの複合B-treeインデックス
- `idx_documents_fts_english` - 英語全文検索のGINインデックス
- `idx_documents_fts_language` - 言語別全文検索のGINインデックス
- `idx_documents_fts_simple` - 簡易全文検索のGINインデックス
- `idx_gin_documents_title` - タイトルのtrigram GINインデックス

### その他の主要インデックス
- `bank_accounts_bank_connection_id_idx` - 銀行接続IDのB-treeインデックス
- `bank_accounts_created_by_idx` - 作成者のB-treeインデックス
- `bank_accounts_team_id_idx` - チームIDのB-treeインデックス
- `invoices_created_at_idx` - 作成日のB-treeインデックス
- `invoices_fts` - 全文検索のGINインデックス
- `invoices_team_id_idx` - チームIDのB-treeインデックス
- `customers_fts` - 全文検索のGINインデックス
- `tags_team_id_idx` - チームIDのB-treeインデックス
- `tracker_projects_fts` - 全文検索のGINインデックス
- `tracker_projects_team_id_idx` - チームIDのB-treeインデックス
- `inbox_attachment_id_idx` - 添付ファイルIDのB-treeインデックス
- `inbox_created_at_idx` - 作成日のB-treeインデックス
- `inbox_team_id_idx` - チームIDのB-treeインデックス
- `inbox_transaction_id_idx` - 取引IDのB-treeインデックス
- `inbox_inbox_account_id_idx` - インボックスアカウントIDのB-treeインデックス

## ベクトルインデックス

### 埋め込みベクトル用インデックス
- `document_tag_embeddings_idx` - ドキュメントタグ埋め込みのIVFFlatインデックス（vector_l2_ops）
- `transaction_embeddings_vector_idx` - 取引埋め込みのHNSWインデックス（vector_cosine_ops）
- `inbox_embeddings_vector_idx` - インボックス埋め込みのHNSWインデックス（vector_cosine_ops）

## Row Level Security (RLS) ポリシー

### 共通ポリシーパターン

#### チームベースアクセス制御
```sql
-- チームメンバーのみがアクセス可能
(team_id IN (SELECT private.get_teams_for_authenticated_user()))
```

#### 認証ユーザーのみ
```sql
-- 認証されたユーザーのみがアクセス可能
to: ["authenticated"]
```

#### 公開アクセス
```sql
-- 誰でもアクセス可能
to: ["public"]
```

### 主要テーブルのポリシー

#### transactions テーブル
- **INSERT**: チームメンバーのみ作成可能
- **SELECT**: チームメンバーのみ閲覧可能
- **UPDATE**: チームメンバーのみ更新可能
- **DELETE**: チームメンバーのみ削除可能

#### invoices テーブル
- **ALL**: チームメンバーのみ全操作可能

#### customers テーブル
- **ALL**: チームメンバーのみ全操作可能

#### documents テーブル
- **INSERT**: 認証ユーザーのみ作成可能
- **SELECT**: チームメンバーのみ閲覧可能
- **UPDATE**: チームメンバーのみ更新可能
- **DELETE**: チームメンバーのみ削除可能

#### users テーブル
- **INSERT**: 自分のプロフィールのみ作成可能
- **SELECT**: 自分のプロフィールまたは同じチームのユーザー
- **UPDATE**: 自分のプロフィールのみ更新可能

## 外部キー制約

### 主要な外部キー関係

#### transactions テーブル
- `assigned_id` → `users.id` (SET NULL on DELETE)
- `team_id` → `teams.id` (CASCADE on DELETE)
- `bank_account_id` → `bank_accounts.id` (CASCADE on DELETE)
- `team_id, category_slug` → `transaction_categories.team_id, transaction_categories.slug`

#### invoices テーブル
- `user_id` → `users.id` (CASCADE on DELETE)
- `customer_id` → `customers.id` (SET NULL on DELETE)
- `team_id` → `teams.id` (CASCADE on DELETE)

#### bank_accounts テーブル
- `bank_connection_id` → `bank_connections.id` (CASCADE on DELETE)
- `created_by` → `users.id` (CASCADE on DELETE)
- `team_id` → `teams.id` (CASCADE on DELETE)

#### documents テーブル
- `owner_id` → `users.id` (SET NULL on DELETE)
- `team_id` → `teams.id` (CASCADE on DELETE)

## 生成列 (Generated Columns)

### 全文検索ベクトル

#### transactions.ftsVector
```sql
to_tsvector(
  'english',
  (
    (COALESCE(name, ''::text) || ' '::text) || COALESCE(description, ''::text)
  )
)
```

#### invoices.fts
```sql
to_tsvector(
  'english',
  (
    (COALESCE((amount)::text, ''::text) || ' '::text) || COALESCE(invoice_number, ''::text)
  )
)
```

#### customers.fts
```sql
to_tsvector(
  'english'::regconfig,
  COALESCE(name, ''::text) || ' ' ||
  COALESCE(contact, ''::text) || ' ' ||
  COALESCE(phone, ''::text) || ' ' ||
  COALESCE(email, ''::text) || ' ' ||
  COALESCE(address_line_1, ''::text) || ' ' ||
  COALESCE(address_line_2, ''::text) || ' ' ||
  COALESCE(city, ''::text) || ' ' ||
  COALESCE(state, ''::text) || ' ' ||
  COALESCE(zip, ''::text) || ' ' ||
  COALESCE(country, ''::text)
)
```

#### documents.fts
```sql
to_tsvector('english'::regconfig, ((title || ' '::text) || body))
```

#### tracker_projects.fts
```sql
to_tsvector(
  'english'::regconfig,
  (
    (COALESCE(name, ''::text) || ' '::text) || COALESCE(description, ''::text)
  )
)
```

#### inbox.fts
```sql
generate_inbox_fts(display_name, extract_product_names((meta -> 'products'::text)))
```

## カスタムデータ型

### tsvector
```typescript
export const tsvector = customType<{
  data: string;
}>({
  dataType() {
    return "tsvector";
  },
});
```

### numericCasted
```typescript
export const numericCasted = customType<{
  data: number;
  driverData: string;
  config: NumericConfig;
}>({
  dataType: (config) => {
    if (config?.precision && config?.scale) {
      return `numeric(${config.precision}, ${config.scale})`;
    }
    return "numeric";
  },
  fromDriver: (value: string) => Number.parseFloat(value),
  toDriver: (value: number) => value.toString(),
});
```

## リレーション定義

### 主要なリレーション

#### transactions リレーション
```typescript
export const transactionsRelations = relations(
  transactions,
  ({ one, many }) => ({
    user: one(users, {
      fields: [transactions.assignedId],
      references: [users.id],
    }),
    team: one(teams, {
      fields: [transactions.teamId],
      references: [teams.id],
    }),
    bankAccount: one(bankAccounts, {
      fields: [transactions.bankAccountId],
      references: [bankAccounts.id],
    }),
    transactionCategory: one(transactionCategories, {
      fields: [transactions.teamId],
      references: [transactionCategories.teamId],
    }),
    transactionTags: many(transactionTags),
    transactionAttachments: many(transactionAttachments),
    inboxes: many(inbox),
  }),
);
```

#### users リレーション
```typescript
export const usersRelations = relations(users, ({ one, many }) => ({
  transactions: many(transactions),
  trackerEntries: many(trackerEntries),
  bankAccounts: many(bankAccounts),
  invoices: many(invoices),
  trackerReports: many(trackerReports),
  reports: many(reports),
  userInvites: many(userInvites),
  documents: many(documents),
  apps: many(apps),
  apiKeys: many(apiKeys),
  shortLinks: many(shortLinks),
  oauthApplications: many(oauthApplications),
  oauthAuthorizationCodes: many(oauthAuthorizationCodes),
  oauthAccessTokens: many(oauthAccessTokens),
  usersInAuth: one(usersInAuth, {
    fields: [users.id],
    references: [usersInAuth.id],
  }),
  team: one(teams, {
    fields: [users.teamId],
    references: [teams.id],
  }),
  usersOnTeams: many(usersOnTeam),
}));
```

#### teams リレーション
```typescript
export const teamsRelations = relations(teams, ({ many }) => ({
  transactions: many(transactions),
  trackerEntries: many(trackerEntries),
  customerTags: many(customerTags),
  inboxAccounts: many(inboxAccounts),
  bankAccounts: many(bankAccounts),
  invoices: many(invoices),
  customers: many(customers),
  tags: many(tags),
  trackerReports: many(trackerReports),
  trackerProjectTags: many(trackerProjectTags),
  reports: many(reports),
  bankConnections: many(bankConnections),
  userInvites: many(userInvites),
  documentTags: many(documentTags),
  transactionTags: many(transactionTags),
  transactionAttachments: many(transactionAttachments),
  documents: many(documents),
  apps: many(apps),
  apiKeys: many(apiKeys),
  shortLinks: many(shortLinks),
  invoiceTemplates: many(invoiceTemplates),
  transactionEnrichments: many(transactionEnrichments),
  users: many(users),
  trackerProjects: many(trackerProjects),
  inboxes: many(inbox),
  documentTagAssignments: many(documentTagAssignments),
  usersOnTeams: many(usersOnTeam),
  transactionCategories: many(transactionCategories),
}));
```

## マテリアライズドビュー

### team_limits_metrics
```sql
SELECT 
  t.id AS team_id, 
  COALESCE(sum((d.metadata ->> 'size'::text)::bigint), 0::numeric) AS total_document_size, 
  count(DISTINCT u.id) AS number_of_users, 
  count(DISTINCT bc.id) AS number_of_bank_connections, 
  count(DISTINCT i.id) FILTER (WHERE date_trunc('month'::text, i.created_at) = date_trunc('month'::text, CURRENT_DATE::timestamp with time zone)) AS invoices_created_this_month, 
  count(DISTINCT inbox.id) FILTER (WHERE date_trunc('month'::text, inbox.created_at) = date_trunc('month'::text, CURRENT_DATE::timestamp with time zone)) AS inbox_created_this_month 
FROM teams t 
LEFT JOIN documents d ON d.team_id = t.id 
LEFT JOIN users u ON u.team_id = t.id 
LEFT JOIN bank_connections bc ON bc.team_id = t.id 
LEFT JOIN invoices i ON i.team_id = t.id 
LEFT JOIN inbox ON inbox.team_id = t.id 
GROUP BY t.id
```

## 制約

### ユニーク制約
- `transactions_internal_id_key` - 取引の内部ID
- `teams_inbox_id_key` - チームのインボックスID
- `unique_rate` - 為替レートの基本通貨・対象通貨の組み合わせ
- `unique_tag_name` - チーム内でのタグ名
- `unique_team_slug` - チーム内でのカテゴリスラッグ
- `unique_app_id_team_id` - チーム内でのアプリID
- `invoice_templates_team_id_key` - チームの請求書テンプレート
- `unique_team_name` - チーム内でのエンリッチメント名
- `unique_slug_per_team` - チーム内でのドキュメントタグスラッグ
- `unique_tag` - 取引タグの組み合わせ
- `unique_customer_tag` - 顧客タグの組み合わせ
- `unique_project_tag` - プロジェクトタグの組み合わせ
- `unique_team_invite` - チーム招待の組み合わせ
- `user_invites_code_key` - 招待コード
- `inbox_reference_id_key` - インボックス参照ID
- `inbox_accounts_email_key` - インボックスアカウントメール
- `inbox_accounts_external_id_key` - インボックスアカウント外部ID
- `unique_bank_connections` - 銀行接続の組み合わせ
- `short_links_short_id_unique` - 短縮リンクID
- `api_keys_key_unique` - APIキーハッシュ
- `oauth_applications_client_id_key` - OAuthクライアントID
- `oauth_authorization_codes_code_key` - OAuth認可コード
- `oauth_access_tokens_token_key` - OAuthアクセストークン
- `oauth_access_tokens_refresh_token_key` - OAuthリフレッシュトークン

### 主キー制約
- ほとんどのテーブルでUUID型の主キーを使用
- 一部のテーブルで複合主キーを使用（例：`document_tag_assignments`）

## パフォーマンス最適化

### インデックス戦略
1. **B-treeインデックス**: 等価比較、範囲検索、ソート用
2. **GINインデックス**: 全文検索、配列検索用
3. **GISTインデックス**: 幾何学的データ、trigram検索用
4. **HNSWインデックス**: ベクトル類似度検索用
5. **IVFFlatインデックス**: 大規模ベクトル検索用

### 全文検索最適化
- PostgreSQLの`tsvector`型を使用
- 英語ロケールでの最適化
- 複数の全文検索ベクトル（英語、簡易、言語別）

### ベクトル検索最適化
- pgvector拡張を使用
- コサイン類似度による高速検索
- 埋め込みベクトルの次元数最適化

## セキュリティ

### 認証・認可
- Supabase Authとの統合
- JWTトークンベースの認証
- チームベースのアクセス制御

### データ暗号化
- APIキーの暗号化保存
- 機密情報のハッシュ化

### 監査ログ
- 作成日時、更新日時の自動記録
- 最終アクセス日時の記録

---

*このドキュメントは `packages/db/src/schema.ts` から自動生成されました。*
*最終更新: 2024年*
