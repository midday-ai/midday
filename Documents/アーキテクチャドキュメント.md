# Midday アーキテクチャドキュメント

## 概要

Middayは、フリーランサー、コンサルタント、個人事業主向けの包括的なビジネス管理ツールです。モノレポ構造を採用し、複数のプラットフォーム（Web、デスクトップ、モバイル）に対応した統合システムを提供しています。

## アーキテクチャ概要

### 技術スタック

#### 基盤技術
- **モノレポ**: Turborepo + Bun
- **言語**: TypeScript
- **フレームワーク**: Next.js 15.4.5
- **UI**: React 19.1.0 + TailwindCSS + Shadcn/ui
- **データベース**: PostgreSQL (Supabase)
- **ORM**: Drizzle ORM

#### プラットフォーム対応
- **Web**: Next.js (Dashboard, Website)
- **デスクトップ**: Tauri 2.x + Vite
- **モバイル**: Expo (開発中)

## システム構成

### 1. アプリケーション層 (apps/)

#### Dashboard (`apps/dashboard`)
- **目的**: メインのWebアプリケーション
- **技術**: Next.js 15.4.5 + React 19.1.0
- **ホスティング**: Vercel
- **主要機能**:
  - 取引管理
  - 請求書作成・管理
  - 時間トラッキング
  - レポート・分析
  - ドキュメント管理

#### Website (`apps/website`)
- **目的**: 企業サイト・マーケティングページ
- **技術**: Next.js + React
- **ホスティング**: Vercel
- **主要機能**:
  - ランディングページ
  - ドキュメントサイト
  - ブログ・アップデート

#### API (`apps/api`)
- **目的**: バックエンドAPI・tRPCサーバー
- **技術**: tRPC + Drizzle ORM
- **ホスティング**: Fly.io
- **主要機能**:
  - RESTful API
  - tRPCエンドポイント
  - データベース操作
  - 認証・認可

#### Engine (`apps/engine`)
- **目的**: 銀行連携エンジン
- **技術**: Hono + Cloudflare Workers
- **ホスティング**: Cloudflare Workers
- **主要機能**:
  - 銀行API統合
  - 取引データ変換
  - 機関検索
  - リアルタイム同期

#### Desktop (`apps/desktop`)
- **目的**: デスクトップアプリケーション
- **技術**: Tauri 2.x + React + Vite
- **主要機能**:
  - オフライン対応
  - システム統合
  - プッシュ通知
  - 自動更新

### 2. パッケージ層 (packages/)

#### データベース関連
- **`@midday/db`**: Drizzle ORM設定・スキーマ定義
- **`@midday/supabase`**: Supabaseクライアント・クエリ

#### UI・コンポーネント
- **`@midday/ui`**: 共通UIコンポーネントライブラリ
- **`@midday/tsconfig`**: TypeScript設定

#### 機能別パッケージ
- **`@midday/documents`**: OCR・文書処理
- **`@midday/email`**: メールテンプレート・送信
- **`@midday/events`**: イベント管理
- **`@midday/inbox`**: インボックス機能
- **`@midday/invoice`**: 請求書生成
- **`@midday/jobs`**: バックグラウンドジョブ
- **`@midday/notification`**: 通知システム
- **`@midday/location`**: 位置情報・地理データ
- **`@midday/import`**: データインポート
- **`@midday/encryption`**: 暗号化機能
- **`@midday/cache`**: キャッシュ管理
- **`@midday/app-store`**: アプリストア統合

#### ユーティリティ
- **`@midday/utils`**: 共通ユーティリティ関数

## インフラストラクチャ

### ホスティング・デプロイメント

#### 主要サービス
- **Supabase**: データベース、ストレージ、認証、リアルタイム
- **Vercel**: Webアプリケーション（Dashboard、Website）
- **Fly.io**: API・tRPCサーバー
- **Cloudflare**: Engine（Workers、KV、Cron）

#### CI/CD
- **GitHub Actions**: 自動ビルド・デプロイ
- **Turborepo**: モノレポ管理・キャッシュ

### 外部サービス統合

#### 銀行連携
- **GoCardLess**: EU地域の銀行接続
- **Plaid**: カナダ・アメリカの銀行接続
- **Teller**: アメリカの銀行接続

#### バックグラウンド処理
- **Trigger.dev**: バックグラウンドジョブ
- **Resend**: トランザクションメール・マーケティングメール

#### 通知・コミュニケーション
- **Novu**: 通知システム
- **Slack**: チーム連携

#### 分析・監視
- **OpenPanel**: イベント・分析
- **Sentry**: エラー監視・ログ
- **OpenStatus**: サービス監視

#### AI・検索
- **Mistral**: AI機能
- **OpenAI**: AI機能
- **Typesense**: 検索エンジン

#### 決済・課金
- **Polar**: 決済処理
- **Stripe**: 決済処理（推測）

## データフロー

### 1. 銀行データ同期フロー
```
1. ユーザー認証 → 2. 銀行接続作成 → 3. Trigger.devジョブ実行
→ 4. Engine API呼び出し → 5. 銀行APIからデータ取得
→ 6. データ変換・保存 → 7. リアルタイム通知
```

### 2. ドキュメント処理フロー
```
1. メール受信 → 2. 添付ファイル保存 → 3. OCR処理
→ 4. データ抽出 → 5. 取引との照合 → 6. 通知送信
```

### 3. 請求書生成フロー
```
1. ユーザー入力 → 2. テンプレート適用 → 3. PDF生成
→ 4. メール送信 → 5. 支払い追跡
```

## セキュリティ

### 認証・認可
- **Supabase Auth**: ユーザー認証
- **Row Level Security (RLS)**: データベースレベルセキュリティ
- **API Keys**: 外部API統合用
- **OAuth**: サードパーティ連携

### データ保護
- **暗号化**: 機密データの暗号化
- **HTTPS**: 全通信の暗号化
- **環境変数**: 機密情報の管理

## パフォーマンス最適化

### フロントエンド
- **Next.js App Router**: サーバーサイドレンダリング
- **React Query**: データキャッシュ・状態管理
- **Turborepo**: ビルドキャッシュ
- **Vite**: 高速開発サーバー

### バックエンド
- **Drizzle ORM**: 効率的なデータベースクエリ
- **Cloudflare Workers**: エッジコンピューティング
- **Redis**: セッション・キャッシュ管理

### データベース
- **インデックス戦略**: 検索パフォーマンス最適化
- **全文検索**: PostgreSQL tsvector
- **ベクトル検索**: pgvector
- **マテリアライズドビュー**: 集計クエリ最適化

## 開発ワークフロー

### 開発環境
- **Bun**: パッケージマネージャー・ランタイム
- **TypeScript**: 型安全性
- **Biome**: コードフォーマット・リント
- **Turbo**: モノレポ管理

### テスト戦略
- **Unit Tests**: 個別コンポーネント・関数
- **Integration Tests**: API・データベース統合
- **E2E Tests**: エンドツーエンドテスト

### デプロイメント戦略
- **Staging**: テスト環境
- **Production**: 本番環境
- **Blue-Green**: ゼロダウンタイムデプロイ

## 監視・ログ

### アプリケーション監視
- **Sentry**: エラー追跡・パフォーマンス監視
- **OpenStatus**: サービス稼働状況
- **Cloudflare Analytics**: トラフィック分析

### ログ管理
- **構造化ログ**: JSON形式
- **ログレベル**: ERROR, WARN, INFO, DEBUG
- **ログ集約**: 中央集約システム

## 今後の拡張計画

### 短期目標
- モバイルアプリ（Expo）の完成
- AI機能の強化
- 多言語対応の拡充

### 長期目標
- エンタープライズ機能
- API公開（Engine）
- パートナー統合の拡大

## 技術的負債・改善点

### 現在の課題
- テストカバレッジの向上
- ドキュメントの充実
- パフォーマンス最適化

### 改善計画
- マイクロサービス化の検討
- リアルタイム機能の強化
- セキュリティ監査の定期実施

---

*最終更新: 2024年12月*
*バージョン: 1.0.0*
```

このアーキテクチャドキュメントは、Middayプロジェクトの包括的な技術構成を説明しています。主要な特徴として：

1. **モノレポ構造**: Turborepo + Bunを使用した効率的な開発環境
2. **マルチプラットフォーム対応**: Web、デスクトップ、モバイル
3. **マイクロサービス的アプローチ**: 機能別パッケージ分割
4. **クラウドネイティブ**: 複数のクラウドサービスを活用
5. **セキュリティ重視**: 多層防御セキュリティ

このドキュメントは、開発チーム、アーキテクト、新規参加者にとって、システム全体の理解を深めるのに役立ちます。
